---
title: TCP的三次握手与四次挥手
tags:
  - TCP
categories:
  - 计算机网络
cover: 'https://www.yellowwei.cn/img/2023-11-16.jpg'
abbrlink: 2935
date: 2023-11-16 18:48:30
---

# TCP 的三次握手

> TCP 协议位于传输层，作用是提供可靠的字节流服务，为了准确无误地将数据送达目的地，TCP 协议采纳三次握手策略。

## 三次握手原理

> 第 1 次握手：客户端发送一个带有 SYN（synchronize）标志的数据包给服务端；
> 第 2 次握手：服务端接收成功后，回传一个带有 SYN/ACK 标志的数据包传递确认信息，表示我收到了；
> 第 3 次握手：客户端再回传一个带有 ACK 标志的数据包，表示我知道了，握手结束。
> 其中：SYN 标志位数置 1，表示建立 TCP 连接；ACK 标志表示验证字段。

![](https://www.yellowwei.cn/img/TCPImage.png)

## 三次握手过程详细说明

> 1. 客户端发送建立 TCP 连接的请求报文，其中报文中包含 seq 序列号，是由发送端随机生成的，并且将报文中的 SYN 字段置为 1，表示需要建立 TCP 连接。（SYN=1，seq=x，x 为随机生成数值）
> 1. 服务端回复客户端发送的 TCP 连接请求报文，其中包含 seq 序列号，是由回复端随机生成的，并且将 SYN 置为 1，而且会产生 ACK 字段，ACK 字段数值是在客户端发送过来的序列号 seq 的基础上加 1 进行回复，以便客户端收到信息时，知晓自己的 TCP 建立请求已得到验证。（SYN=1，ACK=x+1，seq=y，y 为随机生成数值）这里的 ack 加 1 可以理解为是确认和谁建立连接
> 1. 客户端收到服务端发送的 TCP 建立验证请求后，会使自己的序列号加 1 表示，并且再次回复 ACK 验证请求，在服务端发过来的 seq 上加 1 进行回复。（SYN=1，ACK=y+1，seq=x+1）

# TCP 的四次挥手

> 由于 TCP 连接是全双工的，因此每个方向都必须单独进行关闭。这原则是当一方完成它的数据发送任务后就能发送一个 FIN 来终止这个方向的连接。收到一个 FIN 只意味着这一方向上没有数据流动，一个 TCP 连接在收到一个 FIN 后仍能发送数据。首先进行关闭的一方将执行主动关闭，而另一方执行被动关闭

## 四次挥手原理

> 第 1 次挥手：客户端发送一个 FIN，用来关闭客户端到服务端的数据传送，客户端进入 FIN_WAIT_1 状态；
> 第 2 次挥手：服务端收到 FIN 后，发送一个 ACK 给客户端，确认序号为收到序号+1（与 SYN 相同，一个 FIN 占用一个序号），服务端进入 CLOSE_WAIT 状态；
> 第 3 次挥手：服务端发送一个 FIN，用来关闭服务端到客户端的数据传送，服务端进入 LAST_ACK 状态；
> 第 4 次挥手：客户端收到 FIN 后，客户端 t 进入 TIME_WAIT 状态，接着发送一个 ACK 给 Server，确认序号为收到序号+1，服务端进入 CLOSED 状态，完成四次挥手。
> 其中：FIN 标志位数置 1，表示断开 TCP 连接。

![](https://www.yellowwei.cn/img/Snipaste_2023-11-16_19-03-44.png)

## 四次挥手过程详细说明

> 1. 客户端发送断开 TCP 连接请求的报文，其中报文中包含 seq 序列号，是由发送端随机生成的，并且还将报文中的 FIN 字段置为 1，表示需要断开 TCP 连接。（FIN=1，seq=x，x 由客户端随机生成）
> 1. 服务端会回复客户端发送的 TCP 断开请求报文，其包含 seq 序列号，是由回复端随机生成的，而且会产生 ACK 字段，ACK 字段数值是在客户端发过来的 seq 序列号基础上加 1 进行回复，以便客户端收到信息时，知晓自己的 TCP 断开请求已经得到验证。（FIN=1，ACK=x+1，seq=y，y 由服务端随机生成）
> 1. 服务端在回复完客户端的 TCP 断开请求后，不会马上进行 TCP 连接的断开，服务端会先确保断开前，所有传输到 A 的数据是否已经传输完毕，一旦确认传输数据完毕，就会将回复报文的 FIN 字段置 1，并且产生随机 seq 序列号。（FIN=1，ACK=x+1，seq=z，z 由服务端随机生成）
> 1. 客户端收到服务端的 TCP 断开请求后，会回复服务端的断开请求，包含随机生成的 seq 字段和 ACK 字段，ACK 字段会在服务端的 TCP 断开请求的 seq 基础上加 1，从而完成服务端请求的验证回复。（FIN=1，ACK=z+1，seq=h，h 为客户端随机生成）
